// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © realanthonyc https://www.tradingview.com/u/realanthonyc

//@version=5
// -----------------------------------------------------------------------------
//  Price-MA Deviation (Normalized)
//  On GitHub: https://github.com/realanthonyc/Price-MA-Deviation
//  v1.0.6
// -----------------------------------------------------------------------------
indicator("Price-MA Deviation", shorttitle="PMA Deviation", overlay=false, precision=2, explicit_plot_zorder=true)

// === DEVIATION SETTINGS ===

grp_slow = "Slow Price-MA Deviation"
slowSrc    = input.source(hlc3, title="Source", group=grp_slow, display=display.data_window)
slowType   = input.string("SMA", title="Slow Deviation Type", options=["SMA", "EMA"], group=grp_slow)
slowLen    = input.int(200, title="Slow Deviation Length", minval=1, group=grp_slow)
slowNorm   = input.int(200, title="Slow Deviation Normalization Lookback", minval=1, group=grp_slow)

grp_fast = "Fast Price-MA Deviation"
fastSrc    = input.source(hlc3, title="Source", group=grp_fast, display=display.data_window)
fastType   = input.string("EMA", title="Fast Deviation Type", options=["SMA", "EMA"], group=grp_fast)
fastLen    = input.int(20, title="Fast Deviation Length", minval=1, group=grp_fast)
fastNorm   = input.int(150, title="Fast Deviation Normalization Lookback", minval=1, group=grp_fast)

// === CALCULATIONS ===

calc_deviation(src, len, type, normLen) =>
    // 1. Calculate Moving Average based on Type
    maVal = type == "SMA" ? ta.sma(src, len) : ta.ema(src, len)
    // 2. Calculate Raw Percentage Difference
    rawDev = ((src - maVal) / maVal) * 100
    // 3. Normalize to 0-100 Scale based on History
    highestDev = ta.highest(rawDev, normLen)
    lowestDev  = ta.lowest(rawDev, normLen)
    rangeDev   = highestDev - lowestDev
    
    // Return normalized value (default to 50 if flat)
    rangeDev == 0 ? 50 : ((rawDev - lowestDev) / rangeDev) * 100

// Execute Calculations
valFast = calc_deviation(fastSrc, fastLen, fastType, fastNorm)
valSlow = calc_deviation(slowSrc, slowLen, slowType, slowNorm)

// === PLOTTING ===

// Define dynamic colors
colSlow = valSlow >= 50 ? color.rgb(85, 215, 205, 36) : color.rgb(85, 215, 205, 34)
colFast = valFast >= 50 ? color.rgb(0, 181, 162, 0) : color.rgb(255, 100, 100, 0)

// Plot Reference Lines
hTop = hline(100, "Max", color=color.new(color.red, 80), linestyle=hline.style_dotted)
hUpper = hline(80, "Overbought Ref", color=color.new(color.red, 50), linestyle=hline.style_dotted, linewidth=2)
hMid = hline(50, "Midpoint", color=color.new(color.gray, 80), linestyle=hline.style_solid)
hLower = hline(20, "Oversold Ref", color=color.new(color.green, 50), linestyle=hline.style_dotted, linewidth=2)
hBottom = hline(0, "Min", color=color.new(color.green, 80), linestyle=hline.style_dotted)

// Background Fills
fill(hTop, hUpper, color=color.new(color.red, 95), title="Overbought Zone", display=display.none)
fill(hBottom, hLower, color=color.new(color.green, 95), title="Oversold Zone", display=display.none)

// Plot Main Indicators
plot(valSlow, title="Slow Deviation", color=colSlow, linewidth=1)
plot(valFast, title="Fast Deviation", color=colFast, linewidth=2)